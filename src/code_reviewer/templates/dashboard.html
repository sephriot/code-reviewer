<!DOCTYPE html>
<html>
<head>
    <title>Code Review Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin-bottom: 30px; }
        .pr-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .pr-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .pr-meta { color: #666; margin-bottom: 10px; }
        .review-comment { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .original-review-comment { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 3px solid #6c757d; }
        .inline-comments { margin-top: 10px; }
        .inline-comment { background: #fff3cd; padding: 8px; border-left: 3px solid #ffc107; margin: 5px 0; }
        .history-section { margin: 15px 0; }
        .history-title { font-weight: bold; color: #495057; margin-bottom: 8px; }
        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0; }
        .original-content, .final-content { padding: 10px; border-radius: 4px; }
        .original-content { background: #f8f9fa; border-left: 3px solid #6c757d; }
        .final-content { background: #d1ecf1; border-left: 3px solid #bee5eb; }
        .section-header { font-weight: bold; margin-bottom: 5px; color: #495057; }
        .no-content { font-style: italic; color: #6c757d; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-outdated { background: #e2e3e5; color: #495057; }
        .buttons { margin-top: 15px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-view { background: #17a2b8; color: white; }
        .tabs { border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .outdated-note { background: #f1f3f5; padding: 10px; border-left: 3px solid #adb5bd; margin: 10px 0; border-radius: 4px; color: #495057; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 8px; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Code Review Dashboard</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('pending')">Pending Approvals</div>
            <div class="tab" onclick="showTab('human-review')">Human Reviews</div>
            <div class="tab" onclick="showTab('approved')">Approved History</div>
            <div class="tab" onclick="showTab('rejected')">Rejected History</div>
            <div class="tab" onclick="showTab('outdated')">Outdated</div>
            <div class="tab" onclick="showTab('completed-reviews')">Completed Reviews</div>
        </div>
        
        <div id="pending" class="tab-content active">
            <div class="section">
                <h2>PRs Awaiting Your Approval</h2>
                <div id="pending-approvals"></div>
            </div>
        </div>
        
        <div id="human-review" class="tab-content">
            <div class="section">
                <h2>PRs Requiring Human Review</h2>
                <div id="human-reviews"></div>
            </div>
        </div>

        <div id="approved" class="tab-content">
            <div class="section">
                <h2>Approved Approvals History</h2>
                <div id="approved-approvals"></div>
            </div>
        </div>

        <div id="rejected" class="tab-content">
            <div class="section">
                <h2>Rejected Approvals History</h2>
                <div id="rejected-approvals"></div>
            </div>
        </div>

        <div id="outdated" class="tab-content">
            <div class="section">
                <h2>Outdated Pending Approvals</h2>
                <div id="outdated-approvals"></div>
            </div>
        </div>

        <div id="completed-reviews" class="tab-content">
            <div class="section">
                <h2>Last 50 Completed PR Reviews</h2>
                <div id="completed-reviews-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal for approval confirmation -->
    <div id="approval-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Review Approval</h3>
            <div id="modal-pr-info"></div>
            <textarea id="user-comment" placeholder="Optional: Modify the review comment before posting..."></textarea>
            <div class="buttons">
                <button class="btn btn-approve" onclick="confirmApproval()">Approve & Post Review</button>
                <button class="btn btn-reject" onclick="rejectApproval()">Reject</button>
            </div>
        </div>
    </div>

    <script>
        let currentApprovalId = null;

        function refreshCurrentView() {
            // Find the currently active tab and refresh its data
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const activeTabContent = document.querySelector('.tab-content.active');
                if (activeTabContent) {
                    const tabId = activeTabContent.id;
                    switch (tabId) {
                        case 'pending':
                            loadPendingApprovals();
                            break;
                        case 'human-review':
                            loadHumanReviews();
                            break;
                        case 'approved':
                            loadApprovedHistory();
                            break;
                        case 'rejected':
                            loadRejectedHistory();
                            break;
                        case 'completed-reviews':
                            loadCompletedReviews();
                            break;
                    }
                }
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'pending') {
                loadPendingApprovals();
            } else if (tabName === 'human-review') {
                loadHumanReviews();
            } else if (tabName === 'approved') {
                loadApprovedHistory();
            } else if (tabName === 'rejected') {
                loadRejectedHistory();
            } else if (tabName === 'outdated') {
                loadOutdatedApprovals();
            } else if (tabName === 'completed-reviews') {
                loadCompletedReviews();
            }
        }

        async function loadPendingApprovals() {
            try {
                const response = await fetch('/api/pending-approvals');
                const approvals = await response.json();
                const container = document.getElementById('pending-approvals');
                
                if (approvals.length === 0) {
                    container.innerHTML = '<p>No pending approvals.</p>';
                    return;
                }
                
                container.innerHTML = approvals.map(approval => `
                    <div class="pr-card">
                        <div class="pr-title">${approval.pr_title}</div>
                        <div class="pr-meta">
                            ${approval.repository} #${approval.pr_number} by ${approval.pr_author}
                            <br><small>Created: ${new Date(approval.created_at).toLocaleString()}</small>
                        </div>
                        ${approval.display_review_comment ? `
                            <div class="review-comment" id="comment-section-${approval.id}">
                                <strong>Review Comment:</strong>
                                <button class="btn-small edit-btn" onclick="editComment(${approval.id})" style="margin-left: 10px; font-size: 12px; padding: 2px 6px;">Edit</button>
                                <button class="btn-small delete-btn" onclick="deleteComment(${approval.id})" style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background: #dc3545;">Delete</button>
                                <div id="comment-display-${approval.id}" class="comment-display">${approval.display_review_comment}</div>
                                <textarea id="comment-edit-${approval.id}" class="comment-editor" style="display: none; width: 100%; height: 100px; margin: 10px 0;">${approval.display_review_comment}</textarea>
                                <div id="comment-edit-buttons-${approval.id}" style="display: none; margin-top: 5px;">
                                    <button class="btn btn-approve" onclick="saveComment(${approval.id})" style="margin-right: 5px;">Save</button>
                                    <button class="btn" onclick="cancelEditComment(${approval.id})">Cancel</button>
                                </div>
                            </div>` : ''}
                        ${approval.display_review_summary ? `
                            <div class="review-summary" id="summary-section-${approval.id}">
                                <strong>Review Summary:</strong>
                                <button class="btn-small edit-btn" onclick="editSummary(${approval.id})" style="margin-left: 10px; font-size: 12px; padding: 2px 6px;">Edit</button>
                                <button class="btn-small delete-btn" onclick="deleteSummary(${approval.id})" style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background: #dc3545;">Delete</button>
                                <div id="summary-display-${approval.id}" class="summary-display">${approval.display_review_summary}</div>
                                <textarea id="summary-edit-${approval.id}" class="summary-editor" style="display: none; width: 100%; height: 100px; margin: 10px 0;">${approval.display_review_summary}</textarea>
                                <div id="summary-edit-buttons-${approval.id}" style="display: none; margin-top: 5px;">
                                    <button class="btn btn-approve" onclick="saveSummary(${approval.id})" style="margin-right: 5px;">Save</button>
                                    <button class="btn" onclick="cancelEditSummary(${approval.id})">Cancel</button>
                                </div>
                            </div>` : ''}
                        ${approval.inline_comments.length > 0 ? `
                            <div class="inline-comments">
                                <strong>Inline Comments (${approval.inline_comments.length}):</strong>
                                ${approval.inline_comments.map((comment, index) => `
                                    <div class="inline-comment" id="inline-comment-section-${approval.id}-${index}">
                                        <strong>${comment.file}:${comment.line}</strong>
                                        <button class="btn-small edit-btn" onclick="editInlineComment(${approval.id}, ${index})" style="margin-left: 10px; font-size: 12px; padding: 2px 6px;">Edit</button>
                                        <button class="btn-small delete-btn" onclick="deleteInlineComment(${approval.id}, ${index})" style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background: #dc3545;">Delete</button>
                                        <br>
                                        <div id="inline-comment-display-${approval.id}-${index}" class="inline-comment-display">${comment.message}</div>
                                        <textarea id="inline-comment-edit-${approval.id}-${index}" class="inline-comment-editor" style="display: none; width: 100%; height: 80px; margin: 10px 0;">${comment.message}</textarea>
                                        <div id="inline-comment-edit-buttons-${approval.id}-${index}" style="display: none; margin-top: 5px;">
                                            <button class="btn btn-approve" onclick="saveInlineComment(${approval.id}, ${index})" style="margin-right: 5px;">Save</button>
                                            <button class="btn" onclick="cancelEditInlineComment(${approval.id}, ${index})">Cancel</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="buttons">
                            <button class="btn btn-approve" onclick="approveDirectly(${approval.id})">
                                Approve & Post Review
                            </button>
                            <button class="btn btn-reject" onclick="rejectPR(${approval.id})">Reject</button>
                            <a href="${approval.pr_url}" target="_blank" class="btn btn-view">View PR</a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load pending approvals:', error);
            }
        }

        async function loadHumanReviews() {
            try {
                const response = await fetch('/api/human-reviews');
                const reviews = await response.json();
                const container = document.getElementById('human-reviews');
                
                if (reviews.length === 0) {
                    container.innerHTML = '<p>No PRs marked for human review.</p>';
                    return;
                }
                
                container.innerHTML = reviews.map(review => `
                    <div class="pr-card">
                        <div class="pr-title">${review.pr_title}</div>
                        <div class="pr-meta">
                            ${review.repository} #${review.pr_number} by ${review.pr_author}
                            <br><small>Reviewed: ${new Date(review.reviewed_at).toLocaleString()}</small>
                        </div>
                        ${review.review_reason ? `<div class="review-comment"><strong>Reason:</strong><br>${review.review_reason}</div>` : ''}
                        <div class="buttons">
                            <a href="https://github.com/${review.repository}/pull/${review.pr_number}" target="_blank" class="btn btn-view">View PR</a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load human reviews:', error);
            }
        }

        function showApprovalModal(id, title, comment) {
            console.log('showApprovalModal called with:', id, title, comment);
            currentApprovalId = id;
            document.getElementById('modal-pr-info').innerHTML = `<strong>${title}</strong>`;
            document.getElementById('user-comment').value = comment;
            document.getElementById('approval-modal').style.display = 'block';
            console.log('Modal displayed, currentApprovalId:', currentApprovalId);
        }

        function closeModal() {
            document.getElementById('approval-modal').style.display = 'none';
            currentApprovalId = null;
        }

        async function confirmApproval() {
            console.log('confirmApproval called, currentApprovalId:', currentApprovalId);
            if (!currentApprovalId) {
                console.log('No currentApprovalId, returning');
                return;
            }
            
            const userComment = document.getElementById('user-comment').value;
            console.log('User comment:', userComment);
            
            try {
                console.log('Sending approval request to:', `/api/approvals/${currentApprovalId}/approve`);
                const response = await fetch(`/api/approvals/${currentApprovalId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: userComment })
                });
                
                console.log('Response received:', response.status, response.ok);
                
                if (response.ok) {
                    closeModal();
                    refreshCurrentView();
                    alert('PR approved and review posted!');
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert('Failed to approve PR: ' + errorText);
                }
            } catch (error) {
                console.error('Failed to approve PR:', error);
                alert('Failed to approve PR: ' + error.message);
            }
        }

        async function rejectApproval() {
            if (!currentApprovalId) return;
            
            const reason = prompt('Optional: Why are you rejecting this approval?');
            
            try {
                const response = await fetch(`/api/approvals/${currentApprovalId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason || '' })
                });
                
                if (response.ok) {
                    closeModal();
                    refreshCurrentView();
                    alert('Approval rejected');
                } else {
                    alert('Failed to reject approval');
                }
            } catch (error) {
                console.error('Failed to reject approval:', error);
                alert('Failed to reject approval');
            }
        }

        async function rejectPR(id) {
            const reason = prompt('Optional: Why are you rejecting this approval?');
            
            try {
                const response = await fetch(`/api/approvals/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason || '' })
                });
                
                if (response.ok) {
                    refreshCurrentView();
                    alert('Approval rejected');
                } else {
                    alert('Failed to reject approval');
                }
            } catch (error) {
                console.error('Failed to reject approval:', error);
                alert('Failed to reject approval');
            }
        }

        // Inline editing functions
        function editComment(id) {
            document.getElementById(`comment-display-${id}`).style.display = 'none';
            document.getElementById(`comment-edit-${id}`).style.display = 'block';
            document.getElementById(`comment-edit-buttons-${id}`).style.display = 'block';
        }

        function cancelEditComment(id) {
            document.getElementById(`comment-display-${id}`).style.display = 'block';
            document.getElementById(`comment-edit-${id}`).style.display = 'none';
            document.getElementById(`comment-edit-buttons-${id}`).style.display = 'none';
            // Reset textarea to original value
            const displayText = document.getElementById(`comment-display-${id}`).textContent;
            document.getElementById(`comment-edit-${id}`).value = displayText;
        }

        async function saveComment(id) {
            const newComment = document.getElementById(`comment-edit-${id}`).value;
            try {
                const response = await fetch(`/api/approvals/${id}/update-comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: newComment })
                });
                
                if (response.ok) {
                    document.getElementById(`comment-display-${id}`).textContent = newComment;
                    cancelEditComment(id);
                } else {
                    alert('Failed to save comment');
                }
            } catch (error) {
                console.error('Failed to save comment:', error);
                alert('Failed to save comment');
            }
        }

        async function deleteComment(id) {
            if (!confirm('Delete this comment? It will be removed from the review.')) return;
            
            try {
                const response = await fetch(`/api/approvals/${id}/delete-comment`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    document.getElementById(`comment-section-${id}`).style.display = 'none';
                } else {
                    alert('Failed to delete comment');
                }
            } catch (error) {
                console.error('Failed to delete comment:', error);
                alert('Failed to delete comment');
            }
        }

        function editSummary(id) {
            document.getElementById(`summary-display-${id}`).style.display = 'none';
            document.getElementById(`summary-edit-${id}`).style.display = 'block';
            document.getElementById(`summary-edit-buttons-${id}`).style.display = 'block';
        }

        function cancelEditSummary(id) {
            document.getElementById(`summary-display-${id}`).style.display = 'block';
            document.getElementById(`summary-edit-${id}`).style.display = 'none';
            document.getElementById(`summary-edit-buttons-${id}`).style.display = 'none';
            // Reset textarea to original value
            const displayText = document.getElementById(`summary-display-${id}`).textContent;
            document.getElementById(`summary-edit-${id}`).value = displayText;
        }

        async function saveSummary(id) {
            const newSummary = document.getElementById(`summary-edit-${id}`).value;
            try {
                const response = await fetch(`/api/approvals/${id}/update-summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ summary: newSummary })
                });
                
                if (response.ok) {
                    document.getElementById(`summary-display-${id}`).textContent = newSummary;
                    cancelEditSummary(id);
                } else {
                    alert('Failed to save summary');
                }
            } catch (error) {
                console.error('Failed to save summary:', error);
                alert('Failed to save summary');
            }
        }

        async function deleteSummary(id) {
            if (!confirm('Delete this summary? It will be removed from the review.')) return;
            
            try {
                const response = await fetch(`/api/approvals/${id}/delete-summary`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    document.getElementById(`summary-section-${id}`).style.display = 'none';
                } else {
                    alert('Failed to delete summary');
                }
            } catch (error) {
                console.error('Failed to delete summary:', error);
                alert('Failed to delete summary');
            }
        }

        // Inline comment editing functions
        function editInlineComment(approvalId, commentIndex) {
            document.getElementById(`inline-comment-display-${approvalId}-${commentIndex}`).style.display = 'none';
            document.getElementById(`inline-comment-edit-${approvalId}-${commentIndex}`).style.display = 'block';
            document.getElementById(`inline-comment-edit-buttons-${approvalId}-${commentIndex}`).style.display = 'block';
        }

        function cancelEditInlineComment(approvalId, commentIndex) {
            document.getElementById(`inline-comment-display-${approvalId}-${commentIndex}`).style.display = 'block';
            document.getElementById(`inline-comment-edit-${approvalId}-${commentIndex}`).style.display = 'none';
            document.getElementById(`inline-comment-edit-buttons-${approvalId}-${commentIndex}`).style.display = 'none';
            // Reset textarea to original value
            const displayText = document.getElementById(`inline-comment-display-${approvalId}-${commentIndex}`).textContent;
            document.getElementById(`inline-comment-edit-${approvalId}-${commentIndex}`).value = displayText;
        }

        async function saveInlineComment(approvalId, commentIndex) {
            const newMessage = document.getElementById(`inline-comment-edit-${approvalId}-${commentIndex}`).value;
            try {
                const response = await fetch(`/api/approvals/${approvalId}/update-inline-comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: commentIndex, message: newMessage })
                });
                
                if (response.ok) {
                    document.getElementById(`inline-comment-display-${approvalId}-${commentIndex}`).textContent = newMessage;
                    cancelEditInlineComment(approvalId, commentIndex);
                } else {
                    alert('Failed to save inline comment');
                }
            } catch (error) {
                console.error('Failed to save inline comment:', error);
                alert('Failed to save inline comment');
            }
        }

        async function deleteInlineComment(approvalId, commentIndex) {
            if (!confirm('Delete this inline comment? It will be removed from the review.')) return;
            
            try {
                const response = await fetch(`/api/approvals/${approvalId}/delete-inline-comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: commentIndex })
                });
                
                if (response.ok) {
                    // Refresh the current view to update counts and indices
                    refreshCurrentView();
                } else {
                    alert('Failed to delete inline comment');
                }
            } catch (error) {
                console.error('Failed to delete inline comment:', error);
                alert('Failed to delete inline comment');
            }
        }

        async function approveDirectly(id) {
            if (!confirm('Approve and post this review to GitHub?')) return;
            
            // Don't pass comment from DOM - let server use database edited versions
            try {
                const response = await fetch(`/api/approvals/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    refreshCurrentView();
                    alert('PR approved and review posted!');
                } else {
                    const errorText = await response.text();
                    alert('Failed to approve PR: ' + errorText);
                }
            } catch (error) {
                console.error('Failed to approve PR:', error);
                alert('Failed to approve PR: ' + error.message);
            }
        }

        async function loadApprovedHistory() {
            try {
                const response = await fetch('/api/approved-approvals');
                const approvals = await response.json();
                const container = document.getElementById('approved-approvals');
                
                if (approvals.length === 0) {
                    container.innerHTML = '<p>No approved approvals found.</p>';
                    return;
                }
                
                container.innerHTML = approvals.map(approval => {
                    const originalComment = approval.original_review_comment || '';
                    const finalComment = approval.final_review_comment || '';
                    const originalSummary = approval.original_review_summary || '';
                    const finalSummary = approval.final_review_summary || '';
                    const originalInlineComments = approval.original_inline_comments || [];
                    const finalInlineComments = approval.inline_comments || [];
                    
                    return `
                        <div class="pr-card">
                            <div class="pr-title">${approval.pr_title}
                                <span class="status-badge status-approved">APPROVED</span>
                            </div>
                            <div class="pr-meta">
                                ${approval.repository} #${approval.pr_number} by ${approval.pr_author}
                                <br><small>Created: ${new Date(approval.created_at).toLocaleString()}</small>
                                <br><small>Action: ${approval.review_action.replace('_', ' ').toUpperCase()}</small>
                            </div>
                            
                            ${(originalComment || finalComment) ? `
                                <div class="history-section">
                                    <div class="history-title">Review Comments</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original</div>
                                            <div class="content">${originalComment || '<span class="no-content">No comment</span>'}</div>
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final (Posted to GitHub)</div>
                                            <div class="content">${finalComment || '<span class="no-content">No comment</span>'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(originalSummary || finalSummary) ? `
                                <div class="history-section">
                                    <div class="history-title">Review Summary</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original</div>
                                            <div class="content">${originalSummary || '<span class="no-content">No summary</span>'}</div>
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final (Posted to GitHub)</div>
                                            <div class="content">${finalSummary || '<span class="no-content">No summary</span>'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(originalInlineComments.length > 0 || finalInlineComments.length > 0) ? `
                                <div class="history-section">
                                    <div class="history-title">Inline Comments</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original (${originalInlineComments.length})</div>
                                            ${originalInlineComments.length > 0 ? 
                                                originalInlineComments.map(comment => `
                                                    <div class="inline-comment">
                                                        <strong>${comment.file}:${comment.line}</strong><br>
                                                        ${comment.message}
                                                    </div>
                                                `).join('') : 
                                                '<span class="no-content">No inline comments</span>'
                                            }
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final - Posted to GitHub (${finalInlineComments.length})</div>
                                            ${finalInlineComments.length > 0 ? 
                                                finalInlineComments.map(comment => `
                                                    <div class="inline-comment">
                                                        <strong>${comment.file}:${comment.line}</strong><br>
                                                        ${comment.message}
                                                    </div>
                                                `).join('') : 
                                                '<span class="no-content">No inline comments</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="buttons">
                                <a href="${approval.pr_url}" target="_blank" class="btn btn-view">View PR</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load approved history:', error);
            }
        }

        async function loadRejectedHistory() {
            try {
                const response = await fetch('/api/rejected-approvals');
                const approvals = await response.json();
                const container = document.getElementById('rejected-approvals');
                
                if (approvals.length === 0) {
                    container.innerHTML = '<p>No rejected approvals found.</p>';
                    return;
                }
                
                container.innerHTML = approvals.map(approval => {
                    const originalComment = approval.original_review_comment || '';
                    const finalComment = approval.final_review_comment || '';
                    const originalSummary = approval.original_review_summary || '';
                    const finalSummary = approval.final_review_summary || '';
                    const originalInlineComments = approval.original_inline_comments || [];
                    const finalInlineComments = approval.inline_comments || [];
                    
                    return `
                        <div class="pr-card">
                            <div class="pr-title">${approval.pr_title}
                                <span class="status-badge status-rejected">REJECTED</span>
                            </div>
                            <div class="pr-meta">
                                ${approval.repository} #${approval.pr_number} by ${approval.pr_author}
                                <br><small>Created: ${new Date(approval.created_at).toLocaleString()}</small>
                                <br><small>Action: ${approval.review_action.replace('_', ' ').toUpperCase()}</small>
                                ${approval.review_comment ? `<br><small>Rejection Reason: ${approval.review_comment}</small>` : ''}
                            </div>
                            
                            ${(originalComment || finalComment) ? `
                                <div class="history-section">
                                    <div class="history-title">Review Comments (Not Posted)</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original</div>
                                            <div class="content">${originalComment || '<span class="no-content">No comment</span>'}</div>
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final (Not Posted - Rejected)</div>
                                            <div class="content">${finalComment || '<span class="no-content">No comment</span>'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(originalSummary || finalSummary) ? `
                                <div class="history-section">
                                    <div class="history-title">Review Summary (Not Posted)</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original</div>
                                            <div class="content">${originalSummary || '<span class="no-content">No summary</span>'}</div>
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final (Not Posted - Rejected)</div>
                                            <div class="content">${finalSummary || '<span class="no-content">No summary</span>'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(originalInlineComments.length > 0 || finalInlineComments.length > 0) ? `
                                <div class="history-section">
                                    <div class="history-title">Inline Comments (Not Posted)</div>
                                    <div class="comparison-container">
                                        <div class="original-content">
                                            <div class="section-header">Original (${originalInlineComments.length})</div>
                                            ${originalInlineComments.length > 0 ? 
                                                originalInlineComments.map(comment => `
                                                    <div class="inline-comment">
                                                        <strong>${comment.file}:${comment.line}</strong><br>
                                                        ${comment.message}
                                                    </div>
                                                `).join('') : 
                                                '<span class="no-content">No inline comments</span>'
                                            }
                                        </div>
                                        <div class="final-content">
                                            <div class="section-header">Final (Not Posted - Rejected) (${finalInlineComments.length})</div>
                                            ${finalInlineComments.length > 0 ? 
                                                finalInlineComments.map(comment => `
                                                    <div class="inline-comment">
                                                        <strong>${comment.file}:${comment.line}</strong><br>
                                                        ${comment.message}
                                                    </div>
                                                `).join('') : 
                                                '<span class="no-content">No inline comments</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="buttons">
                                <a href="${approval.pr_url}" target="_blank" class="btn btn-view">View PR</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load rejected history:', error);
            }
        }

        async function loadOutdatedApprovals() {
            try {
                const response = await fetch('/api/outdated-approvals');
                const approvals = await response.json();
                const container = document.getElementById('outdated-approvals');

                if (approvals.length === 0) {
                    container.innerHTML = '<p>No outdated approvals.</p>';
                    return;
                }

                container.innerHTML = approvals.map(approval => `
                    <div class="pr-card">
                        <div class="pr-title">${approval.pr_title}</div>
                        <div class="pr-meta">
                            ${approval.repository} #${approval.pr_number} by ${approval.pr_author}
                            <br><small>Originally queued: ${new Date(approval.created_at).toLocaleString()}</small>
                        </div>
                        <div class="outdated-note">
                            <span class="status-badge status-outdated">OUTDATED</span>
                            This pending approval was cleared automatically because the pull request is no longer open.
                        </div>
                        ${approval.display_review_comment ? `
                            <div class="review-comment">
                                <strong>Original Comment:</strong>
                                <div>${approval.display_review_comment}</div>
                            </div>` : ''}
                        ${approval.display_review_summary ? `
                            <div class="review-comment">
                                <strong>Original Summary:</strong>
                                <div>${approval.display_review_summary}</div>
                            </div>` : ''}
                        ${approval.inline_comments.length > 0 ? `
                            <div class="inline-comments">
                                <strong>Inline Comments (${approval.inline_comments.length}):</strong>
                                ${approval.inline_comments.map((comment) => `
                                    <div class="inline-comment">
                                        <strong>${comment.file}:${comment.line}</strong><br>
                                        ${comment.message}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="buttons">
                            <a href="${approval.pr_url}" target="_blank" class="btn btn-view">View PR</a>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load outdated approvals:', error);
            }
        }

        async function loadCompletedReviews() {
            try {
                const response = await fetch('/api/completed-reviews');
                const reviews = await response.json();
                const container = document.getElementById('completed-reviews-list');
                
                if (reviews.length === 0) {
                    container.innerHTML = '<p>No completed reviews found.</p>';
                    return;
                }
                
                container.innerHTML = reviews.map(review => {
                    const actionBadge = getActionBadge(review.review_action);
                    
                    return `
                        <div class="pr-card">
                            <div class="pr-title">${review.pr_title}
                                ${actionBadge}
                            </div>
                            <div class="pr-meta">
                                ${review.repository} #${review.pr_number} by ${review.pr_author}
                                <br><small>Reviewed: ${new Date(review.reviewed_at).toLocaleString()}</small>
                                <br><small>Head SHA: ${review.head_sha ? review.head_sha.substring(0, 8) : 'N/A'}</small>
                                ${review.inline_comments_count > 0 ? `<br><small>Inline Comments: ${review.inline_comments_count}</small>` : ''}
                            </div>
                            
                            ${review.review_comment ? `
                                <div class="review-comment">
                                    <strong>Review Comment:</strong><br>
                                    ${review.review_comment}
                                </div>
                            ` : ''}
                            
                            ${review.review_summary ? `
                                <div class="review-comment">
                                    <strong>Review Summary:</strong><br>
                                    ${review.review_summary}
                                </div>
                            ` : ''}
                            
                            ${review.review_reason ? `
                                <div class="review-comment">
                                    <strong>Review Reason:</strong><br>
                                    ${review.review_reason}
                                </div>
                            ` : ''}
                            
                            <div class="buttons">
                                <a href="https://github.com/${review.repository}/pull/${review.pr_number}" target="_blank" class="btn btn-view">View PR</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load completed reviews:', error);
            }
        }

        function getActionBadge(action) {
            switch (action) {
                case 'approve_with_comment':
                    return '<span class="status-badge status-approved">APPROVED WITH COMMENT</span>';
                case 'approve_without_comment':
                    return '<span class="status-badge status-approved">APPROVED</span>';
                case 'request_changes':
                    return '<span class="status-badge status-rejected">CHANGES REQUESTED</span>';
                case 'requires_human_review':
                    return '<span class="status-badge" style="background: #fff3cd; color: #856404;">HUMAN REVIEW</span>';
                default:
                    return `<span class="status-badge" style="background: #e2e3e5; color: #6c757d;">${action.replace('_', ' ').toUpperCase()}</span>`;
            }
        }

        // Load initial data
        loadPendingApprovals();
    </script>
</body>
</html>